# 开发日志
> renjiayi, from 2024.06.11

这是所有实验分支版本 ResBranches 的主模块，不同分支版本使用不同时期主模块版本开发，注意看日志。

- 启动参数包含三项，目前（2024.10.23）只实装了 A 参数。
    - *exp_cfg_A*
    - *exp_cfg_B*
    - *exp_cfg_C*

## 已知问题
- **（暂时搁置）**并不算是太大的问题，影响很小：由 config 中 grid 字典的键作为随机数种子生成的矩阵，在不同阶段相同键生成的矩阵是完全相同的，故应该让各阶段字典的键保持不同。但是在 kernel 的 `.STAGE_task` 中的循环调用逻辑写成依托了，需要先改掉这段随机排序字典并循环的实现方法（这里已修改），才能改 config 里面的键。另一个修复方法是变更不同阶段 grid 字典的尺寸参数，以保持差异，实际进行实验时，手动调一调 config.py 里的键，花不了太大的功夫，改它反而花的时间更多。
- **（未知问题）**主任务中存在严重的图形性能问题，手柄操作后需要 500ms 的响应时间，很可能与 *pyglet* 的底层实现有关，难以修复。
    - 通过减小矩阵的规模，可以明显感受到延迟的降低，后续研究中可以将矩阵规模锁定在 7×7，并适当增加奖励格子的密度和 trial 数量，以提升被试的操作体验。

## 开发计划
### 已中止
- **（已放弃）**~~用数据库或二进制序列化优化 `data_proc` 目录中的数据存储形式。~~
- **（已放弃）**~~将实验后问题以事件形式添加进 kernel.py，须注意双人的每个项目应该独立呈现，不应存在等待条件。~~
- **（已放弃）**~~将是否允许透支步数调整为 `.moveto` 方法的参数 (allow_overdraft)，默认为 False；由于 `.__legal_destination` 套用了 @property 装饰器，此参数不可用，并且对实验而言意义不大。~~
- **（已放弃）**~~在双方操作走方格时，需要额外预测对方下一步的选择。~~
    ~~- `kernel.py`：将手柄操纵的控制逻辑从 `.__page_trial` 方法中分离，单独创建一个方法。~~
- **（已变更）**~~在 2024.09.27b 之后，需要重新调整策略竞争阶段的操作。~~
    - ~~grid.py: `.legal_destination` 取消套用 @property，增加是否允许透支步数、是否为竞争阶段的参数，并同步修改 kernel.py 中的调用方式。~~
    - ~~kernel.py: `.__page_trial` 根据是否是策略竞争阶段，控制结束条件、是否允许重置步数、是否允许主动结束游戏。~~
- **（已变更）**~~优化任务界面：~~
    - ~~右侧的操作提示变更为动态文本，受到 `.__render_misc` 方法的参数控制，可选择呈现操作提示（练习阶段）、任务目标（策略竞争 / 正式实验）。~~
    - ~~为 2024.09.27b 后续版本优化提示信息。~~
~~- **（已放弃）**为启动参数的 clue 增加被试内变量选项，并且同步调整 `kernel.py` 中的实现。（topic 变量不适合设置被试内选项。）~~
~~- **（见附注）**实际测试中发现，正式任务中会自动点按“结束本轮”选项，被试均声称没有进行任何按键操作，14 次实验出现过 2 次这样的现象，未能排查出原因。（**注：**如果是手柄输入造成的问题，如误触，那么已经通过增加组合确认按键来修复；如果是底层的 `grid.step < 0` 异常造成的问题，则还需在实验中观察。）~~
~~- **（已放弃）**重新设计一个策略能力测试阶段，可以基于 `grid.py` 和 `kernel.py` 开发，并尽量利用已有的绘制函数————需重构的函数数量太多，难以实现。~~
### 计划中
- 在 UI 界面直观显示双方收益。
    - 每一轮理论上的最高收益为 47 分，三轮共 141 分，分摊到每人平均 70.5 分。
    - 如果出于自私的动机，则估算消耗 7 分时便会停止，此时分数为 41 分，三轮共 123 分，分摊到每人平均 61.5 分。
    - 收益计算：队伍分数 / 2.5。

## 2024.10.31
- 重新手动设计练习矩阵，用于人工进行操作指引。

## 2024.10.30
- 已取消浪费步数的惩罚。
- 修复了如果双方的回答完全相同（不相似条件）或完全不同（相似条件）时闪退的问题，尽管实际发生率极低。

## 2024.10.29
- 浪费步数时，改为双方各扣除剩余步数的分数。

## 2024.10.25b
- 重新区分了练习阶段、正式前测、正式后测。
    - 支持前后测实验设计。
    - 调整了分数的渲染逻辑，练习阶段（stage == 0）和前测（stage == 1）不再显示双方分数。

## 2024.10.25a
- 扩充 `jshub.py` 的功能，现在可以读取并返回部分前-后组合按键（'back_RB'），并且检测的时间窗可控。
    - 为结束当前轮次（RB）增加一个二次确认的操作（back -> RB）。
    - 如果是输入源的问题，那么**可能**修复了实验中少数的异常自动结束轮次的问题。
- 修改 `__choice_result` 方法的实现，现在可以统一用于两种测试任务。

## 2024.10.23
- 使用外部模块 `jshub.py` 来统一处理双手柄的输入检测。

## 2024.10.18
- 改用 `pylsl` 标准库来打 mark，现在 mark 统一在 `flow.py` 中写，不再写入 `kernel.py`，以保持代码的整洁。

## 2024.10.15
- 增加了一个 jshub.py 的功能模块，用于独立处理双手柄输入信息，忽略重复按键，并以字符串形式返回双手柄的按键名称。
    - 自带 `win_flipper` 对象用于刷新。
    - 需在外部创建 `js_before` 和 `while` 循环。
    - 需在外部手动刷新 `win_flipper`。
- 已在控制台中完成调试，暂未运用到 kernel.py 中。

## 2024.10.13
- 修复 bug：特质相似性实验中，“相似”条件下讨论页面闪退的问题（未给另一方的呈现文字内容变量赋值）。

## 2024.10.12
- 修复 bug：特质相似性实验中，“不相似”条件下，两个窗口中讨论部分显示的双方的回答是相同的。

## 2024.10.11
- 泛化三个启动参数的功能和名称，启动参数既可以实验程序内部刺激状态，也可以决定实验流程模块的调用规则，还可以用于记录实验外部操纵水平。
- 增加了 #wasted 字段的记录，用浪费的次数而非步数来衡量非默契指标更为恰当。
- 修复了一些逻辑上的 bug。

## 2024.10.09
- 调整了一些 UI 细节。
    - 将 grid 外的剩余步数显示变更为总分，并删除了 strategy_competition / render_total 参数。
- 不再有 strategy_competition 阶段的实现，现在策略竞争阶段改为二选一任务。
- 调整数值；重置步数变更为 10，初始消耗分数变更为 1。
- （已完成，暂未调试）将 .STAGE_choice 的功能扩充到思维能力测试，并在 test_result 中提供虚假的能力反馈。

## 2024.09.28
- 进一步调整规则：
    - 在起始位置（黑色格子）上按 RB，立即结束当前 trial。
    - 在空白格子（灰色格子）上按 LB，使用 5+i 分重置步数（8 步），i 为当前 trial 已重置次数。
    - 调整数值（待进一步优化）。
- 用颜色区分不同分值的格子。
- 调整了主任务的 UI（待进一步优化）。

## 2024.09.27
*当日同时保存了 a/b 两个版本，查看 versions.md 中的详情。*
- 调整每个 trial 结束的判定规则：没有合法的格子可走，并在当前 trial 结束时添加 `core.wait(1)`。
- b 版本调整的规则：
    - 不再有蓝色格子了（只是通过调整 elegen 函数的参数实现的）。
    - 在所有抉择格子（白色）上按 LB，可以使用 1 分兑换 5 步；在所有抉择格子（白色）上按 RB，立刻结束 trial。
    - 数据文件中同步记录：浪费的步数、双方兑换步数的次数。
    - 数据文件中不再记录：以往与 bonus_steps 相关的数据。

## 2024.09.26
- `elegen.py`：添加一个函数，可以生成有限制条件的矩阵。
    - 相同的分数、步数格子不能出现在同一行、同一列（空格子不受限）。

## 2024.09.24
- 将 `gen_bonus` 函数的奖励格子、步数奖励格子的参数调整为绝对数值类型而非比率。
- 在空白格子中增加“-1步”的提示。

## 2024.09.23
- 改良实验任务，具体涉及的变化包括：
    - `config.py`：将矩阵尺寸缩减为 7×7 及以下，优化性能。
    - `config.py`：删除所有空白格子，所有格子要么是减步数加分，要么是加步数减分。（通过调整 `config.element_generator` 的参数实现。）
    - `elegen.py`：调整步数与分数奖惩的数值。
    - `grid.py`：每次行走不再消耗额外的 1 步，但走回头路会消耗 1 步。
    - `kernel.py`：优化矩阵中方格内的显示内容，统一显示为 `±i步 ±j分`，并且不同步数与分数增加值通过色组区分出来。
    - `grid.py` & `kernel.py`: **禁止**最后一步**透支步数**的操作。
- `grid.legal_loca` 因未知原因没有删干净非法欠步数的格子。
- `grid.legal_loca` 中无法移除当前方格自身的位置，会出现允许原地踏步的操作（原因：横向、纵向各需要删除一次）。

## 2024.09.12
- 启动参数增加 exp_cfg_goal，并同步写入 log 和 data 文件，可通过 `instance.Condition_Goal` 访问属性并决定指导语的呈现规则。
- 优化个人 / 队伍得分渲染逻辑，其中 `strategy_competition` 关键字参数的判定优先级最高。
- 观点讨论页面（`.STAGE_discussion`）会同时呈现双方的观点，并优化的部分文案。
- 在特定尺寸的网格下，`.__loca_unit` 方法的两个分支可能存在均不满足的情况，导致报错；通过更改两个分支的判断方式来修复此问题。
                line 435, in __loca_unit
                loca_unit[(i,j)] = (loca_list_x[i], loca_list_y[j])
                UnboundLocalError: local variable 'loca_list_x' referenced before assignment
- 严格来说不算问题，主要是 `.clear_info` 执行时机的问题：如果要在策略测试前、后都添加一个正式实验，那么再策略测试结束调用 `.clear_info` 后，最终在 `.finale` 里呈现的就是第二个正式实验阶段的结果了。这只影响被试费的发放，绝对不会影响实验数据————如果被试在二阶段不认真，厌烦了，应付了事，那少拿点被试费也算是**自找的**。已通过传参解决。
- 移除启动参数 exp_cfg_clue，通过 exp_cfg_goal 来决定分数的呈现形式（个人分数 / 队伍总分）；优化分数渲染的逻辑；将 `render_total` 参数关键字更改为 `strategy_competition`，判断是否渲染总分的逻辑反转。

## 2024.09.09
- 修复当 destination 横、纵坐标出现 0 时，`.__record_proc` 方法写入异常 END_OF_TRIAL 的问题，并增加 step 字段的写入。

## 2024.09.06
- **（此修改同步自 branch_1）**将个人分数、队伍总分的渲染逻辑分开，二者不会再同时呈现；在 `STAGE_task` 方法中增加 `render_total`（已更名）关键字参数，用于控制策略竞争阶段的分数呈现机制，其在决定分数渲染逻辑的参数中的判定优先级最高。

## 2024.08.31
- 重新优化过程性数据的文本记录方式。
- 在 `.render_misc` 方法中增加了 render_total 参数，以控制是否渲染队伍总分。
- 将写死的奖励格子、步数奖励格子比例改为 `.gen_bonus` 的参数。
- 增加功能：策略能力评估阶段。并增加 `.result_strategy` 方法以辅助其实现。
- 增加`.clear_info`方法，扩充 elegen（原 generator 模块）的功能参数。

> 下列日志已归档，不再维护。
## 早期版本日志：2024.06.11 ~ 2024.08.30
### 待办事项
- 记录实验的过程性日志数据，将每一次选择保存为 .txt 文件。
- 扩充讨论话题的领域，并同步修改指导语，领域包括：行为习惯、能力专长、价值观。
- 将四阶段实验改为两阶段，但阶段之间进行连续的三次话题讨论。
- 添加话题选择与筛选呈现的页面实现逻辑。
- 添加事件计时器 global 与 local。
- 将所有指导语制作为 2400*1600 pix 的图文，用位图替换纯文字材料。
- 遴选`.STAGE_opinion`阶段的话题材料。
- 完善数据文件格式与 `.record` 方法。
- 分别通过 `parallel.PORT` class 和 `serial.Serial` class 实现 `.set_marker` 方法。
- 补全 flow.py 中的实验流程。
- 增加个人数据记录，包括（个人贡献的步数和次数）。
- 改各类社会比较线索的指导语（关注分数：设定个人/团体的优良中差总分线）。
- 优化 `.__page_choice` 方法的按键引导。
- 每一个 trial 结束后，应单独呈现队伍总分与双方得分（3s）。
## 错误修复
#### 底层实现 bug
- grid.py：执行 `.__add_element` 之后，再执行 `.__rotate`，可能会导致旋转后的 bonus 坐标与初始位置重合。
- 操作过程中，两个窗口中，双方分数没有分别显示预期数值，`self.win0` 双方均为 0 分，`self.win1` 双方均等于总分。
- 修改双方得分、队伍总分的清零时机，原：每个 trial 结束时；改：每个 stage 结束时。
- 每个 stage 分并非每次得分的累加，而变成了每个 trial 分累加的累加；现在二者独立计算，前者不再依赖后者。
- 当矩阵横纵方格数不相等（Grid 参数 m != n）时，会闪退，`self.__loca_unit[i]` 出现了不存在的键，与 `grid.__legal_loca` 中的赋值错误有关。
- 实验实现过程中，并没有执行旋转逻辑。将 `stage` 参数从 `grid.__init__` 中分离，作为 Experiment 对象的初始化参数。
#### 图形界面 bug
- 基础图形没有边框。
- 图层渲染顺序错误，合法区域会挡住奖励网格。
- 所有可移动区域似乎重合到一个位置了。
- 合法的可移动位置随着拟移动位置而变化，而非只取决于当前位置。
- 初始位置的旋转似乎只旋转了初始的拟移动位置，而没有旋转初始的方块位置。
- 渲染 hud、misc 尺寸不应该与 `self.__unit_size` 有关。
- 文字尺寸异常。
- 文字位置异常，需调整 kernel.py 中的 `.__loca_misc` 接口。
- 文字尺寸没有按照预期随分辨率自适应缩放。
#### 硬件交互 bug
- 手柄操作中，`self.js1` 操作会闪退，而 `self.js0` 却不会。
- **（原因未知，但已通过改键暂时性修复）**当从 `.__page_trial` 切换到 `.__page_choice` 第一页时，最后一个操作方格的人会默认选中“是”选项。
### 交互优化
- **（已实现）**当矩阵中没有奖励网格（底层数据结构体现为 bonus 的值均为 (0,0)）时 break 掉当前循环。
- **（已实现）**优化配色方案。
- **（已实现）**突出当前操作角色提示。
- **（已实现）**将剩余步数放进当前位置的方格中。
- **（通过变更图形界面布局来部分实现）**存在社会比较线索的条件下，突出当前得分更高角色分数的呈现方式。
- **（已实现）**在结束页上增加了分数汇总信息。
### 性能优化
- **（通过减少重复运算量部分实现，但未能实现渲染层面使用双重缓冲进行优化）**每一次按键重新渲染整个图形，导致手柄操作延迟在 500ms 左右。考虑在移动选区时只执行 `grid.__render_hud`，且不清空 buffer 以保留其余图层。
### 材料生成
- **（已实现）**创建模块实现自动生成（固定）矩阵 bonus / element 字典的功能。要求矩阵中包含 bonus 的网格不少于 2/3，并且步数总加成数量不宜过多。
